{% extends 'base.html' %}
{% load static %}

{% block title %}Chat Room: {{ room_name }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    {% if user.is_authenticated %}
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-comments"></i> Chat Room: {{ room_name }}
          </h5>
        </div>
        <div class="card-body p-0">
          <div id="chat_messages"></div>
        </div>
      </div>
      
      <form id="chat_message_form">
        {% csrf_token %}
        <div class="input-group">
          <input
            type="text"
            name="message"
            class="form-control"
            placeholder="Type your message..."
            autocomplete="off"
            required />
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Send
          </button>
        </div>
      </form>
    {% else %}
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        You must be logged in to join the chat room.
      </div>
    {% endif %}
  </div>
  
  <div class="col-lg-4">
    <div id="connected_users">
      <h5><i class="fas fa-users"></i> Connected Users</h5>
      <ul id="users_list" class="list-unstyled"></ul>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/{{ room_name }}/");

  function shouldAutoScroll() {
    const chatMessages = document.getElementById("chat_messages");
    return chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50;
  }

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    // Type 1 : normal chat message
    if (data.message && data.username || data.activity) {
      const chatMessages = document.getElementById("chat_messages");
      const messageElement = document.createElement("div");
      if (data.activity) {
        messageElement.innerHTML = "<em>" + data.activity + "</em>";
      } else {
        messageElement.innerHTML = "<strong>" + data.username + ":</strong> " + data.message;
      }
      chatMessages.appendChild(messageElement);
      if (shouldAutoScroll()) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    // Type 2 : connected users list update
    if (data.connected_users) {
      const usersList = document.getElementById("users_list");
      usersList.innerHTML = "";
      data.connected_users.forEach(function (username) {
        const userElement = document.createElement("li");
        userElement.textContent = username;
        usersList.appendChild(userElement);
      });
    }
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
  };

  $(document).ready(function () {
    $("#chat_message_form").on("submit", function (e) {
      e.preventDefault();
      const messageInput = $('input[name="message"]');
      const message = messageInput.val();
      chatSocket.send(JSON.stringify({ message: message }));
      messageInput.val("");
    });
  });
</script>
{% endblock javascript %}

{% block extra_css %}
<style>
 #chat_messages {
    height: 400px;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 10px;
}

#chat_messages div {
    margin-bottom: 8px;
}

#chat_messages em {
    color: #6c757d;
    font-size: 0.9em;
}

#connected_users {
    max-height: 200px;
    overflow-y: auto;
}

#users_list li {
    padding: 5px 0;
}
</style>
{% endblock %}